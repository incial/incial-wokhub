version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1.2

jobs:
  build-and-deploy:
    docker:
      - image: cimg/openjdk:17.0
    environment:
      AWS_REGION: ap-south-1
    steps:
      - checkout

      # -----------------------------
      # Build Spring Boot JAR
      # -----------------------------
      - run:
          name: Build Backend JAR
          command: |
            cd server
            mvn clean package -DskipTests

      # -----------------------------
      # Enable Remote Docker (amd64)
      # Required for buildx cross-arch builds
      # -----------------------------
      - setup_remote_docker:
          docker_layer_caching: true

      # -----------------------------
      # Setup AWS CLI
      # -----------------------------
      - aws-cli/setup

      # -----------------------------
      # Login to Amazon ECR
      # -----------------------------
      - run:
          name: Login to Amazon ECR
          command: |
            aws ecr get-login-password --region $AWS_REGION | \
            docker login \
              --username AWS \
              --password-stdin \
              ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

      # -----------------------------
      # Build & Push ARM64 Image (CROSS-ARCH)
      # NOTE:
      # CircleCI runs on amd64
      # EC2 is aarch64
      # => buildx is MANDATORY
      # -----------------------------
      - run:
          name: Build and Push ARM64 Docker Image
          command: |
            cd server

            docker buildx create --use --name arm-builder || docker buildx use arm-builder

            docker buildx build \
              --platform linux/arm64 \
              -t ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}:${CIRCLE_SHA1:0:7} \
              --push .

      # -----------------------------
      # Deploy to ARM EC2 via SSM
      # -----------------------------
      - run:
          name: Deploy to EC2 via SSM
          command: |
            aws ssm send-command \
              --region $AWS_REGION \
              --instance-ids ${EC2_INSTANCE_ID} \
              --document-name "AWS-RunShellScript" \
              --comment "Deploy backend ${CIRCLE_SHA1:0:7}" \
              --parameters commands="[
                \"set -e\",
                \"docker pull ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}:${CIRCLE_SHA1:0:7}\",
                \"docker stop incial-backend || true\",
                \"docker rm incial-backend || true\",
                \"docker run -d \
                   --name incial-backend \
                   --env-file /home/ec2-user/incial.env \
                   --restart unless-stopped \
                   -p 8080:8080 \
                   ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}:${CIRCLE_SHA1:0:7}\",
                \"docker ps\"
              ]"

workflows:
  deploy:
    jobs:
      - build-and-deploy:
          filters:
            branches:
              only: main
